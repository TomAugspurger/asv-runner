#!/usr/bin/env bash

cd /home/{{ ansible_user }}/asv-collection

{% for item in repositories %}
echo syncing {{ item.project }}
git -C /home/{{ ansible_user }}/{{ item.project }} checkout gh-pages
rsync -a /home/{{ ansible_user }}/{{ item.project }}/ {{ item.project }}/
rm -rf {{ item.project }}/.git
rm -rf {{ item.project }}/{{ item.package }}  # maybe remove the project repo
rm -rf {{ item.project }}/build
rm -rf {{item.project }}/{{ item.asv_config | dirname }}/env       # TODO: parse asv.conf.json
rm -rf {{item.project }}/{{ item.asv_config | dirname }}/.asv/env  # TODO: parse asv.conf.json

git -C /home/{{ ansible_user }}/{{ item.project }} checkout -
{% endfor %}

git config --global user.email "tom.w.augspurger@gmail.com"
git config --global user.name "ASV Bot"
git add .
git commit -am "Autogenerated"
GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa" git push -f origin master
